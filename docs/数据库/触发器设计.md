## 触发器设计

### 1. 书籍管理触发器
- **`after_book_insert_trigger`**: 在新增书籍记录时，自动创建库存记录。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_book_insert_trigger
    AFTER INSERT ON book_store_book
    FOR EACH ROW
    BEGIN
        INSERT INTO book_store_inventory (book_id, status, location)
        VALUES (NEW.book_id, 'available', 'default_location');
    END //
    DELIMITER ;
    ```

- **`before_book_delete_trigger`**: 在删除书籍记录之前，删除与该书籍相关的库存记录和订单记录。
    ```sql
    DELIMITER //
    CREATE TRIGGER before_book_delete_trigger
    BEFORE DELETE ON book_store_book
    FOR EACH ROW
    BEGIN
        DELETE FROM book_store_inventory WHERE book_id = OLD.book_id;
        DELETE FROM book_store_order WHERE book_id = OLD.book_id;
    END //
    DELIMITER ;
    ```

### 2. 库存管理触发器
- **`after_inventory_update_trigger`**: 在库存状态更新时，自动检查库存是否达到最低库存阈值，并生成缺书记录（如果需要）。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_inventory_update_trigger
    AFTER UPDATE ON book_store_inventory
    FOR EACH ROW
    BEGIN
        IF NEW.status = 'available' AND NEW.inventory_id <= 10 THEN
            INSERT INTO book_store_book_shortage (book_id, title, supplier, quantity, record_date)
            SELECT book_id, title, supplier, (10 - NEW.inventory_id), CURDATE()
            FROM book_store_book WHERE book_id = NEW.book_id;
        END IF;
    END //
    DELIMITER ;
    ```

### 3. 缺书管理触发器
- **`after_shortage_insert_trigger`**: 在生成缺书记录时，自动触发采购单生成逻辑。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_shortage_insert_trigger
    AFTER INSERT ON book_store_book_shortage
    FOR EACH ROW
    BEGIN
        INSERT INTO book_store_procurement_order (book_id, quantity)
        VALUES (NEW.book_id, NEW.quantity);
    END //
    DELIMITER ;
    ```

### 4. 订单管理触发器
- **`after_order_insert_trigger`**: 在生成订单时，自动扣减客户余额。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_order_insert_trigger
    AFTER INSERT ON book_store_order
    FOR EACH ROW
    BEGIN
        UPDATE book_store_reader
        SET balance = balance - NEW.price
        WHERE reader_id = NEW.reader_id;
    END //
    DELIMITER ;
    ```

- **`before_order_delete_trigger`**: 在删除订单之前，恢复已扣减的客户余额。
    ```sql
    DELIMITER //
    CREATE TRIGGER before_order_delete_trigger
    BEFORE DELETE ON book_store_order
    FOR EACH ROW
    BEGIN
        UPDATE book_store_reader
        SET balance = balance + OLD.price
        WHERE reader_id = OLD.reader_id;
    END //
    DELIMITER ;
    ```

### 5. 发货管理触发器
- **`after_shipping_update_trigger`**: 在订单状态为“shipped”或“delivered”时，自动更新库存中相应书籍的数量。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_shipping_update_trigger
    AFTER UPDATE ON book_store_order
    FOR EACH ROW
    BEGIN
        IF NEW.status IN ('shipped', 'delivered') THEN
            UPDATE book_store_inventory
            SET status = 'sold'
            WHERE book_id = NEW.book_id AND status = 'reserved';
        END IF;
    END //
    DELIMITER ;
    ```

### 6. 客户管理触发器
- **`after_customer_update_trigger`**: 在更新客户信息时，自动记录更改时间，以便追踪。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_customer_update_trigger
    AFTER UPDATE ON book_store_reader
    FOR EACH ROW
    BEGIN
        INSERT INTO customer_update_log (reader_id, update_time)
        VALUES (NEW.reader_id, CURDATE());
    END //
    DELIMITER ;
    ```

### 7. 供应商管理触发器
- **`before_supplier_delete_trigger`**: 在删除供应商信息之前，检查该供应商是否有未处理的采购单，如果有，禁止删除。
    ```sql
    DELIMITER //
    CREATE TRIGGER before_supplier_delete_trigger
    BEFORE DELETE ON book_store_supplier
    FOR EACH ROW
    BEGIN
        IF EXISTS (SELECT 1 FROM book_store_procurement_order WHERE supplier = OLD.name AND status = 'pending') THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot delete supplier with pending procurement orders.';
        END IF;
    END //
    DELIMITER ;
    ```

### 8. 采购管理触发器
- **`after_procurement_order_update_trigger`**: 在采购单状态更新时，自动检查是否有库存已更新，并更新库存状态。
    ```sql
    DELIMITER //
    CREATE TRIGGER after_procurement_order_update_trigger
    AFTER UPDATE ON book_store_procurement_order
    FOR EACH ROW
    BEGIN
        IF NEW.status = 'received' THEN
            UPDATE book_store_inventory
            SET status = 'available'
            WHERE book_id = NEW.book_id AND status = 'reserved';
        END IF;
    END //
    DELIMITER ;
    ```
